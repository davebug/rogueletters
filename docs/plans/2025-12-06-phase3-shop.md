# Phase 3: Shop Implementation Plan

**Date:** 2025-12-06
**Status:** Ready to implement
**Depends on:** Phase 2 (Economy)

## Overview

Add an in-run shop where players spend coins on modifiers that affect gameplay. The shop appears after each earnings screen, before the next round begins.

## Design Summary (from IDEAS.md)

**4 shop slots:**
1. **Tile Set Upgrade** — always available, based on current tile set (Plastic for now)
2. **Random Modifier #1** — drawn from upgrade pool
3. **Random Modifier #2** — drawn from upgrade pool
4. **Random Modifier #3** — drawn from upgrade pool

**Pricing:**
- Tile Set Upgrade: $3 first purchase, $4 second, $5 third, etc. (persists across run)
- Random Modifiers: $3 / $4 / $5 for 1st / 2nd / 3rd purchase this shop visit (resets each round)

**Skip:** Player can skip the shop without buying anything.

---

## Implementation Stages

Each stage is play-testable. Stop and verify before moving on.

---

## Stage 1: Shop UI Shell

**Goal:** Shop screen appears in the flow. No purchasing yet — just navigation.

### Flow Change

```
Round Complete → Earnings Screen → [Continue] → Shop Screen → [Skip] → Next Round
```

### Tasks

- [ ] Add shop screen HTML structure (4 card slots + skip button)
- [ ] Style shop screen to match roguelike theme
- [ ] Wire up earnings "Continue" button to show shop instead of starting next round
- [ ] Wire up shop "Skip" button to start next round
- [ ] Placeholder content in cards ("Coming soon" or similar)

### Shop Screen Mockup

```
┌─────────────────────────────────────────────────────────────┐
│  [Header: Set 1 | Round 1/3 | $12]                          │
├─────────────────────────────────────────────────────────────┤
│                          SHOP                               │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│  │ Tile Set    │ │ Modifier    │ │ Modifier    │ │ Modifier    │
│  │ Upgrade     │ │             │ │             │ │             │
│  │             │ │             │ │             │ │             │
│  │ $3          │ │ $3          │ │ $3          │ │ $3          │
│  │ [ Buy ]     │ │ [ Buy ]     │ │ [ Buy ]     │ │ [ Buy ]     │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
│                                                             │
│                       [ Skip ]                              │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [Footer]                                                   │
└─────────────────────────────────────────────────────────────┘
```

### Play-Test Checklist

- [ ] Complete a round → see earnings → click Continue → see shop
- [ ] Shop displays 4 cards
- [ ] Click Skip → next round starts
- [ ] Header shows correct set/round/coins
- [ ] Flow feels smooth, no jarring transitions

---

## Stage 2: Purchasing Mechanics

**Goal:** Can buy items. Coins deduct. No gameplay effects yet.

### State Changes

Add to `runState`:
```javascript
// Shop state
shopPurchasesThisVisit: 0,    // Resets each shop visit (for pricing)
tileSetUpgradeCount: 0,       // Persists across run (for pricing)
modifiers: []                  // Active modifiers [{id, name, ...}]
```

### Tasks

- [ ] Implement shop item data structure
- [ ] Generate shop contents (1 tile set upgrade + 3 random placeholders)
- [ ] Display real prices based on purchase counts
- [ ] Click "Buy" → deduct coins → mark item as sold
- [ ] Can't buy if insufficient coins (button disabled/dimmed)
- [ ] Update header coin display after purchase
- [ ] Track purchases for pricing escalation
- [ ] "SOLD" badge on purchased items

### Pricing Logic

```javascript
function getTileSetUpgradePrice() {
  return 3 + runState.tileSetUpgradeCount;  // $3, $4, $5, ...
}

function getRandomModifierPrice() {
  return 3 + runState.shopPurchasesThisVisit;  // $3, $4, $5 per visit
}
```

### Play-Test Checklist

- [ ] First item costs $3
- [ ] After buying, next random modifier costs $4
- [ ] Can't buy items you can't afford
- [ ] Coins deduct correctly
- [ ] Sold items show "SOLD" and can't be re-purchased
- [ ] Tile set upgrade price persists across rounds ($3 → $4 → $5)
- [ ] Random modifier prices reset each shop visit

---

## Stage 3: First Modifiers (Tile Value Boosts)

**Goal:** Implement 3-5 simple modifiers that actually affect gameplay.

### Starter Modifier Pool

Keep it simple — all tile value boosts:

| ID | Name | Effect | Description |
|----|------|--------|-------------|
| `vowel_plus_1` | Vowel Power | +1 to all vowels (A, E, I, O, U) | "Vowels are worth +1" |
| `consonant_plus_1` | Consonant Power | +1 to all consonants | "Consonants are worth +1" |
| `letter_e_plus_2` | E Mastery | +2 to letter E | "E tiles are worth +2" |
| `letter_s_plus_2` | S Mastery | +2 to letter S | "S tiles are worth +2" |
| `rare_plus_3` | Rare Gems | +3 to J, Q, X, Z | "Rare letters worth +3 more" |

### Tile Set Upgrade (Plastic)

| ID | Name | Effect | Description |
|----|------|--------|-------------|
| `plastic_upgrade` | Reinforce | +1 to 3 random common letters | "Upgrade 3 random tiles" |

Each purchase picks 3 different common letters (E, A, I, O, N, R, T, L, S) and adds +1 to each.

### Implementation

**Modifier application:**
```javascript
function getModifiedTileValue(letter, baseValue) {
  let value = baseValue;

  for (const mod of runState.modifiers) {
    if (mod.id === 'vowel_plus_1' && 'AEIOU'.includes(letter)) {
      value += 1;
    }
    if (mod.id === 'consonant_plus_1' && !'AEIOU'.includes(letter)) {
      value += 1;
    }
    if (mod.id === 'letter_e_plus_2' && letter === 'E') {
      value += 2;
    }
    // ... etc
  }

  return value;
}
```

**Where to apply:**
- Score calculation (when word is submitted)
- Tile display (show modified value on tile)

### Tasks

- [ ] Define modifier data structure and starter pool
- [ ] Implement `getModifiedTileValue()` function
- [ ] Hook into score calculation
- [ ] Update tile display to show modified values
- [ ] Shop generates random modifiers from pool
- [ ] Purchased modifiers added to `runState.modifiers`
- [ ] Implement Plastic tile set upgrade (random +1 to 3 letters)
- [ ] Visual indicator on modified tiles (glow, different color, badge?)

### Play-Test Checklist

- [ ] Buy "Vowel Power" → vowels show +1 on tiles
- [ ] Score correctly includes modifier bonuses
- [ ] Multiple modifiers stack correctly
- [ ] Tile set upgrade picks 3 random letters and boosts them
- [ ] Can buy same modifier type multiple times (stacks)
- [ ] Modifiers persist across rounds within a run
- [ ] New run resets all modifiers

---

## Stage 4: Expanded Modifier Pool

**Goal:** Full variety of modifiers for replayability.

### Additional Modifiers

**Scoring Bonuses:**
| ID | Name | Effect | Description |
|----|------|--------|-------------|
| `word_5_plus_5` | Five Alive | +5 points for 5-letter words | "+5 for 5-letter words" |
| `word_6_plus_10` | Sixer | +10 points for 6+ letter words | "+10 for 6+ letter words" |
| `all_different_plus_3` | Variety | +3 for words with all different letters | "+3 for unique letters" |

**Economy:**
| ID | Name | Effect | Description |
|----|------|--------|-------------|
| `extra_bonus_plus_10pct` | Overflow | +10% extra bonus (round up) | "Extra bonus +10%" |
| `base_payout_plus_1` | Stipend | +$1 base payout per round | "+$1 per round" |

**Resource:**
| ID | Name | Effect | Description |
|----|------|--------|-------------|
| `extra_turn` | Overtime | +1 turn this set only | "+1 turn this set" |

### Tasks

- [ ] Add scoring bonus modifiers
- [ ] Add economy modifiers (affect `calculateEarnings`)
- [ ] Add resource modifiers (affect turn count)
- [ ] Ensure pool has enough variety (10+ modifiers)
- [ ] Consider rarity/weighting for random selection
- [ ] Prevent duplicate modifiers in same shop (unless intentional)

### Play-Test Checklist

- [ ] Scoring bonuses apply correctly
- [ ] Economy modifiers affect earnings screen
- [ ] Extra turn actually gives +1 turn
- [ ] Good variety in shop offerings
- [ ] No broken combinations
- [ ] Game still feels balanced

---

## Stage 5: Polish & Balance

**Goal:** Refine the experience based on play-testing.

### Tasks

- [ ] Tune pricing (is $3/4/5 right?)
- [ ] Tune modifier values (too strong? too weak?)
- [ ] Add modifier descriptions/tooltips
- [ ] Show active modifiers somewhere (header? sidebar?)
- [ ] Animation when buying (coin deduction, card flip?)
- [ ] Sound effects (optional)
- [ ] Handle edge cases (0 coins, all items too expensive)

### Active Modifiers Display

Need a way to see what modifiers you have. Options:
1. Small icons in header
2. Expandable panel
3. Always-visible sidebar (on wide screens)

### Play-Test Checklist

- [ ] Easy to see what modifiers are active
- [ ] Prices feel fair
- [ ] Modifiers feel impactful but not broken
- [ ] Shop doesn't slow down the game too much
- [ ] Skip is a valid choice (not always optimal to buy)

---

## State Summary

### runState additions

```javascript
// Shop
shopPurchasesThisVisit: 0,    // For random modifier pricing
tileSetUpgradeCount: 0,       // For tile set upgrade pricing
modifiers: [],                // Active modifiers [{id, name, effect, ...}]

// Tile modifications (from Plastic upgrades)
tileBoosts: {},               // e.g., {E: 1, A: 1, T: 1} = +1 to E, A, T
```

### Screen Flow

```
Playing
  ↓ (round complete, target met)
Earnings Screen
  ↓ [Continue]
Shop Screen
  ↓ [Skip] or [buy items then done]
  ├── If Round 1 or 2 → Next Round
  └── If Round 3 → Set Complete Screen → Next Set
```

---

## Files to Modify

1. `script.js` — Shop logic, modifier effects, state changes
2. `index.html` — Shop screen HTML
3. `styles.css` — Shop styling
4. `testing/` — Add shop tests (optional but recommended)

---

## Out of Scope (Phase 4+)

- Gem currency
- Permanent upgrades
- Multiple tile sets (Glass, Copper, etc.)
- Main menu
- Meta-progression

---

## Design Decisions

**When does shop appear?**
→ After every round (including Round 3, before Set Complete)

**Modified tile display:**
→ Keep original value visible, but show it in red to indicate upgrade
→ Example: E normally shows "1", with modifier shows "1" in red

**Zero coins:**
→ Show shop anyway with all options dimmed (player sees what they're missing)

**Reroll option:**
→ Yes, but save for later (not in v1)
